<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLASS11UP</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #10141f;
            --secondary-bg: #1b212c;
            --card-bg: #283040;
            --button-active: #00aeff; /* Changed button color for better visibility */
            --button-hover: #33bbff;
            --text-primary: #ffffff;
            --text-secondary: #a0a8b9;
            --glow-color: rgba(0, 174, 255, 0.5);
            --glow-1: #00aaff;
            --glow-2: #8A2BE2;
            --glow-3: #00ffc3;
            --fav-red: #e74c3c;
            --online-green: #2ecc71;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            background-image: radial-gradient(circle at top, rgba(27, 33, 44, 0.8), transparent 60%);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-top: 0; /* Add padding top to prevent content from hiding behind timer */
        }

        /* --- NEW: TIMER BAR STYLES --- */
        #timer-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(90deg, var(--glow-1), var(--glow-2));
            color: white;
            text-align: center;
            padding: 8px 0;
            font-family: 'Exo 2', sans-serif;
            font-size: 16px;
            font-weight: 600;
            z-index: 1999; /* High z-index to stay on top */
            display: none; /* Hidden by default */
            box-shadow: 0 4px 15px rgba(0, 174, 255, 0.4);
        }
        #timer-bar.visible {
            display: block;
            animation: slideDown 0.5s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Adjust main container padding when timer is visible */
         body.timer-active .main-container {
            padding-top: 50px; /* Adjust based on timer bar height */
        }


        /* --- SCI-FI SPLASH SCREEN --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--primary-bg); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.5s ease-out, visibility 0.5s; }
        #splash-screen.hidden { opacity: 0; visibility: hidden; }
        .sci-fi-icon { width: 80px; height: 80px; margin-bottom: 20px; position: relative; }
        .sci-fi-icon svg { width: 100%; height: 100%; z-index: 2; position: relative; }
        .sci-fi-icon .glow { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, var(--button-active) 10%, transparent 70%); filter: blur(20px); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(0.8); opacity: 0.7; } 50% { transform: scale(1.2); opacity: 1; } }
        #splash-screen h1 { font-family: 'Exo 2', sans-serif; font-size: 28px; font-weight: 700; color: var(--text-primary); margin-bottom: 30px; letter-spacing: 2px; }
        .loading-bar-container { width: 80%; max-width: 300px; height: 4px; background-color: var(--secondary-bg); border-radius: 2px; overflow: hidden; }
        .loading-bar { width: 0%; height: 100%; border-radius: 2px; background: linear-gradient(90deg, var(--button-active), var(--glow-3)); animation: fill-bar 2.5s ease-out forwards; }
        @keyframes fill-bar { from { width: 0%; } to { width: 100%; } }

        /* --- LOADER --- */
        .loader-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 20, 31, 0.8); backdrop-filter: blur(5px); z-index: 1000; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; opacity: 1; }
        .loader-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 50px; height: 50px; border: 5px solid var(--card-bg); border-top-color: var(--button-active); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* --- GENERAL & PREMIUM STYLES --- */
        .page { display: none; min-height: 100vh; }
        .page.active { display: block; animation: page-enter 0.6s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes page-enter { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .main-container { padding: 20px; }
        .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .page-header .icon-btn { font-size: 22px; cursor: pointer; color: var(--text-primary); }
        .page-header .logo { height: 40px; width: 40px; border-radius: 50%; object-fit: cover; }
        .glowing-title { font-family: 'Exo 2', sans-serif; flex-grow: 1; text-align: center; font-size: 22px; font-weight: 700; color: transparent; text-transform: uppercase; background: linear-gradient(90deg, var(--glow-1), var(--glow-2), var(--glow-3), var(--glow-1)); background-size: 200% auto; -webkit-background-clip: text; background-clip: text; animation: gradient-flow 8s linear infinite; text-shadow: 0 0 3px rgba(255,255,255,0.4), 0 0 8px var(--glow-2); }
        @keyframes gradient-flow { to { background-position: -200% center; } }
        .inner-page-header { display: flex; align-items: center; margin-bottom: 30px; }
        .inner-page-header .back-arrow { font-size: 22px; cursor: pointer; color: var(--text-primary); margin-right: 20px;}
        .inner-page-header .title { font-family: 'Exo 2', sans-serif; font-size: 24px; font-weight: 600; }
        .search-container { position: relative; margin-bottom: 20px; }
        .search-input { width: 100%; background-color: var(--secondary-bg); border: 1px solid var(--card-bg); border-radius: 10px; padding: 15px 20px; color: var(--text-primary); font-size: 16px; transition: border-color 0.3s, box-shadow 0.3s; }
        .search-input:focus { border-color: var(--button-active); box-shadow: 0 0 15px var(--glow-color); outline: none; }
        .tabs { display: flex; background-color: var(--secondary-bg); border-radius: 10px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { font-family: 'Exo 2', sans-serif; flex: 1; padding: 12px; background: none; border: none; color: var(--text-secondary); font-size: 16px; font-weight: 500; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, color 0.3s, transform 0.2s; }
        .tab-btn.active, .tab-btn:hover { background-color: var(--button-active); color: white; transform: translateY(-2px); }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .batch-card, .subject-card, .chapter-card { display: block; text-decoration: none; color: var(--text-primary); background-color: var(--card-bg); border-radius: 12px; margin-bottom: 20px; overflow: hidden; border: 1px solid transparent; transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease; animation: fadeInUp 0.5s ease-out forwards; }
        .batch-card:hover, .subject-card:hover, .chapter-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 25px var(--glow-color); border-color: var(--button-active); }
        .batch-card img { width: 100%; height: 150px; object-fit: cover; display: block; }
        .batch-card .card-content { display: flex; align-items: center; justify-content: space-between; padding: 15px; font-family: 'Exo 2', sans-serif; }
        .fav-icon { font-size: 20px; cursor: pointer; z-index: 10; color: var(--text-secondary); transition: color 0.3s, transform 0.3s; }
        .fav-icon:hover { transform: scale(1.2); }
        .fav-icon.is-favourite { color: var(--fav-red); animation: heart-beat 0.5s ease; }
        @keyframes heart-beat { 0% { transform: scale(1); } 50% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .subject-card, .chapter-card { padding: 20px; font-family: 'Exo 2', sans-serif; }
        .chapter-card { border-left: 4px solid var(--button-active); }
        .sub-chapter-card { margin-left: 20px; border-left-color: var(--glow-3); }
        .chapter-card h5 i { margin-right: 10px; color: var(--glow-3); }
        .content-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .content-tab-btn { font-family: 'Exo 2', sans-serif; padding: 8px 15px; background-color: var(--secondary-bg); border: none; color: var(--text-secondary); border-radius: 20px; cursor: pointer; transition: background-color 0.3s, color 0.3s; }
        .content-tab-btn.active, .content-tab-btn:hover { background-color: var(--button-active); color: white; }
        .content-panel { display: none; }
        .content-panel.active { display: block; animation: page-enter 0.5s ease-out; }
        .content-list-item a { text-decoration: none; color: var(--text-secondary); display: flex; align-items:center; gap: 15px; padding: 15px; background-color: var(--secondary-bg); border-radius: 8px; margin-bottom: 8px; transition: background-color 0.3s, color 0.3s, transform 0.3s, box-shadow 0.3s; }
        .content-list-item a:hover { background-color: var(--card-bg); color: white; transform: translateX(5px); box-shadow: 0 0 10px var(--glow-color); }
        .content-list-item a i { width: 20px; text-align: center; color: var(--button-active); font-size: 1.1em; transition: color 0.3s, transform 0.3s; }
        .content-list-item a:hover i { color: var(--glow-3); transform: scale(1.1); }
        
        .sidebar { position: fixed; top: 0; left: -280px; width: 270px; height: 100%; background-color: var(--secondary-bg); transition: left 0.4s cubic-bezier(0.25, 1, 0.5, 1); z-index: 1500; display: flex; flex-direction: column; padding: 20px 0; border-right: 1px solid var(--card-bg); box-shadow: 5px 0 25px rgba(0,0,0,0.3); }
        .sidebar.open { left: 0; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 1499; }
        .overlay.show { display: block; }
        .sidebar-header { text-align: center; padding: 0 20px; margin-bottom: 20px; }
        .sidebar-header .logo { height: 60px; width: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
        .sidebar-header .title { font-family: 'Exo 2', sans-serif; font-size: 24px; font-weight: 600; text-transform: uppercase; }
        .sidebar-header .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; }
        .sidebar-links li a { font-family: 'Exo 2', sans-serif; color: var(--text-secondary); text-decoration: none; display: flex; align-items: center; padding: 15px 20px; font-size: 16px; transition: background-color 0.3s, color 0.3s; }
        .sidebar-links li a:hover { background-color: var(--button-active); color: white; }
        .sidebar-links li a i { margin-right: 15px; width: 20px; }
        .sidebar-footer { margin-top: auto; text-align: center; padding: 20px; font-size: 14px; color: #888; }
        
        .active-user-container { color: var(--text-secondary); font-size: 14px; margin-bottom: 10px; }
        .active-user-container i { color: var(--online-green); animation: pulse-green 2s infinite; }
        @keyframes pulse-green { 0%, 100% { transform: scale(1); box-shadow: 0 0 3px var(--online-green); } 50% { transform: scale(1.1); box-shadow: 0 0 8px var(--online-green); } }

        /* --- NEW: ACCESS VERIFICATION MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(16, 20, 31, 0.8); backdrop-filter: blur(8px); z-index: 1600; display: flex; align-items: center; justify-content: center; transition: opacity 0.3s, visibility 0.3s; opacity: 0; visibility: hidden; }
        .modal-overlay:not(.hidden) { opacity: 1; visibility: visible; }
        .modal-content { font-family: 'Poppins', sans-serif; background: var(--secondary-bg); border-radius: 15px; padding: 30px; width: 90%; max-width: 400px; text-align: center; border: 1px solid var(--card-bg); box-shadow: 0 10px 40px rgba(0,0,0,0.5); position: relative; animation: modal-enter 0.4s cubic-bezier(0.25, 1, 0.5, 1); }
        @keyframes modal-enter { from { opacity: 0; transform: scale(0.9) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        .modal-content .close-modal-btn { position: absolute; top: 10px; right: 15px; font-size: 28px; color: var(--text-secondary); cursor: pointer; transition: color 0.3s, transform 0.3s; }
        .modal-content .close-modal-btn:hover { color: var(--text-primary); transform: rotate(90deg); }
        .modal-icon { width: 60px; height: 60px; margin: 0 auto 15px; background-color: var(--button-active); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 0 20px var(--glow-color); }
        .modal-content h2 { font-family: 'Exo 2', sans-serif; font-size: 26px; margin-bottom: 10px; color: var(--text-primary); }
        .modal-content p { color: var(--text-secondary); margin-bottom: 25px; line-height: 1.6; }
        #generate-key-btn { width: 100%; padding: 15px; font-size: 18px; font-weight: 600; color: white; background: var(--button-active); border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; box-shadow: 0 5px 20px var(--glow-color); }
        #generate-key-btn:hover { background-color: var(--button-hover); transform: translateY(-3px); }
        .modal-content .tutorial-link { margin-top: 20px; color: var(--text-primary); font-weight: 500; cursor: pointer; }
        .modal-content .tutorial-link i { margin-right: 8px; color: var(--button-active); }
        .modal-content .tutorial-steps { text-align: left; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-bg); }
        .modal-content .tutorial-steps p { font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; }
        .modal-content .tutorial-steps i { margin-right: 12px; width: 20px; text-align: center; color: var(--glow-3); }
        .modal-content .tutorial-steps i.fa-lightbulb { color: #f1c40f; }
        .modal-content .tutorial-steps i.fa-bullseye { color: #e74c3c; }
        .modal-content .tutorial-steps i.fa-exclamation-triangle { color: #f39c12; }
        .success-message { font-size: 20px; font-weight: 500; color: var(--text-primary); }
        #success-state.hidden, #initial-state.hidden { display: none; }
        
        @media (min-width: 600px) { #batch-list, #subject-list { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; } }
        @media (min-width: 900px) { #batch-list, #subject-list { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>
    <div id="timer-bar" class="hidden"></div>

    <div id="splash-screen">
        <div class="sci-fi-icon">
            <div class="glow"></div>
            <svg viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <path d="M50 10 V 90 M10 50 H 90 M25 25 L 75 75 M25 75 L 75 25"></path>
                <circle cx="50" cy="50" r="20"></circle>
                <circle cx="50" cy="50" r="40"></circle>
            </svg>
        </div>
        <h1>CLASS11UP</h1>
        <div class="loading-bar-container"><div class="loading-bar"></div></div>
    </div>

    <div id="loader" class="loader-overlay hidden"><div class="spinner"></div></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-xmark close-btn" id="close-btn"></i>
            <a id="sidebar-logo-link" href="#" target="_blank"><img src="" alt="Logo" class="logo"></a>
            <span class="title">CLASS11UP</span>
        </div>
        <ul class="sidebar-links">
            <li><a id="telegram-link" href="#" target="_blank"><i class="fa-brands fa-telegram"></i> Join Telegram</a></li>
            <li><a id="contact-link" href="#" target="_blank"><i class="fa-solid fa-headset"></i> Help & Support</a></li>
        </ul>
        <div class="sidebar-footer">
            <div class="active-user-container">
                <i class="fa-solid fa-circle"></i> <span id="active-users-count">0</span> Active Now
            </div>
            Made with ‚ù§Ô∏è in India by CLASS11UP
        </div>
    </aside>
    <div class="overlay" id="overlay"></div>
    
    <div id="access-verification-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div id="initial-state">
                <span class="close-modal-btn">&times;</span>
                <div class="modal-icon"><i class="fas fa-lock"></i></div>
                <h2>Access Verification</h2>
                <p>Please complete a quick step to unlock this batch.</p>
                <button id="generate-key-btn">Generate Access Key</button>
                <div class="tutorial-steps">
                    <p><i class="fas fa-lightbulb"></i> Watch the tutorial before generating your key.</p>
                    <p><i class="fas fa-bullseye"></i> Follow the steps exactly as shown in the video.</p>
                    <p><i class="fas fa-exclamation-triangle"></i> After completing the step, this page will refresh automatically.</p>
                </div>
            </div>
            <div id="success-state" class="hidden">
                 <div class="modal-icon" style="background-color: var(--online-green);"><i class="fas fa-check"></i></div>
                 <h2>Key Generated!</h2>
                 <p class="success-message">koi shortenlink nhi hai yrr tu Aram se padaii kr üôè (padaii rukna nhi chahiye mitrrrrr üí™)</p>
                 <p>Redirecting you to the batch...</p>
            </div>
        </div>
    </div>

    <div id="home-page" class="page">
        <div class="main-container">
            <header class="page-header">
                <div class="header-left"><i class="fa-solid fa-bars icon-btn" id="menu-btn"></i></div>
                <h2 class="glowing-title">CLASS11UP</h2>
                <div class="header-right"><a id="header-logo-link" href="#" target="_blank"><img src="" alt="Logo" class="logo"></a></div>
            </header>
            <div class="search-container"><input type="text" class="search-input" id="batch-search" placeholder="Search batches..."></div>
            <div class="tabs" id="batch-tabs">
                <button class="tab-btn active" data-tab="total">All Batches</button>
                <button class="tab-btn" data-tab="favourites">Favourites</button>
            </div>
            <div id="batch-list"></div>
        </div>
    </div>
    
    <div id="subjects-page" class="page">
        <div class="main-container">
            <header class="inner-page-header"><a class="back-arrow">&larr;</a><h2 class="title" id="subjects-page-title"></h2></header>
            <div id="subject-list"></div>
        </div>
    </div>
    
    <div id="chapters-page" class="page">
         <div class="main-container">
            <header class="inner-page-header"><a class="back-arrow">&larr;</a><h2 class="title" id="chapters-page-title"></h2></header>
            <div id="chapter-list"></div>
        </div>
    </div>

    <div id="content-page" class="page">
        <div class="main-container">
           <header class="inner-page-header"><a class="back-arrow">&larr;</a><h2 class="title" id="content-page-title"></h2></header>
           <div class="content-tabs" id="content-tabs-container"></div>
           <div id="content-panels-container"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC1m25mHpA59xBQmF34BfA1K_vY2pUSrLI",
            authDomain: "fahad-portfolio-81c65.firebaseapp.com",
            databaseURL: "https://fahad-portfolio-81c65-default-rtdb.firebaseio.com",
            projectId: "fahad-portfolio-81c65",
            storageBucket: "fahad-portfolio-81c65.firebasestorage.app",
            messagingSenderId: "510625882446",
            appId: "1:510625882446:web:b23f76808b3dd0e79a3e1f"
        };
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        let allData = {};
        const loader = document.getElementById('loader');
        const allPages = document.querySelectorAll('.page');
        const accessModal = document.getElementById('access-verification-modal');
        let currentBatchIdToUnlock = null;
        let timerInterval = null; // Variable to hold the timer interval

        // --- COOKIE HELPER FUNCTIONS ---
        function setCookie(name, value, hours) {
            let expires = "";
            if (hours) {
                const date = new Date();
                date.setTime(date.getTime() + (hours * 60 * 60 * 1000));
                expires = "; expires=" + date.toUTCString();
            }
            document.cookie = name + "=" + (value || "")  + expires + "; path=/";
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i=0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
        
        function deleteCookie(name) {
            document.cookie = name + '=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;';
        }

        setTimeout(() => {
            document.getElementById('splash-screen').classList.add('hidden');
        }, 2500);

        function showPage(pageId) {
            allPages.forEach(p => p.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) targetPage.classList.add('active');
        }

        function navigate(pageId, state = {}) {
            history.pushState({ page: pageId, ...state }, '', `#${pageId}`);
            renderPage(pageId, state);
        }

        window.onpopstate = (event) => {
            const state = event.state || { page: 'home-page' };
            renderPage(state.page, state);
        };

        function renderPage(pageId, state) {
            loader.classList.remove('hidden');
            try {
                showPage(pageId);
                switch (pageId) {
                    case 'home-page': renderHomePage(); break;
                    case 'subjects-page': renderSubjectsPage(state.batchId); break;
                    case 'chapters-page': renderChaptersPage(state.batchId, state.subjectId); break;
                    case 'content-page': renderContentPage(state.path); break;
                    default: renderHomePage();
                }
            } catch (error) {
                console.error("Error rendering page:", error);
                renderHomePage();
            } finally {
                setTimeout(() => loader.classList.add('hidden'), 200);
            }
        }
        
        // --- NEW/MODIFIED TIMER FUNCTIONS ---
        function updateTimerDisplay(batchId) {
            const timerBar = document.getElementById('timer-bar');
            const endTime = getCookie(`unlock_expires_${batchId}`);
            
            if (!endTime) {
                timerBar.classList.remove('visible');
                document.body.classList.remove('timer-active');
                if (timerInterval) clearInterval(timerInterval);
                return;
            }

            timerBar.classList.add('visible');
            document.body.classList.add('timer-active');
            
            if (timerInterval) clearInterval(timerInterval); // Clear any existing timer

            timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = endTime - now;

                if (distance < 0) {
                    clearInterval(timerInterval);
                    timerBar.classList.remove('visible');
                    document.body.classList.remove('timer-active');
                    deleteCookie(`unlock_expires_${batchId}`);
                    // Optionally, re-render the current page to reflect locked status
                    const state = history.state || { page: 'home-page' };
                    renderPage(state.page, state);
                    return;
                }

                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                timerBar.textContent = `Time Left: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function startOrResumeTimer() {
             if (!allData.batches) return;
             const batchIds = Object.keys(allData.batches);
             for(const batchId of batchIds) {
                 const expiryTimestamp = getCookie(`unlock_expires_${batchId}`);
                 if (expiryTimestamp && new Date().getTime() < parseInt(expiryTimestamp)) {
                     updateTimerDisplay(batchId);
                     break; // Assuming only one timer can be active at a time
                 }
             }
        }

        function renderHomePage() {
            const batchListDiv = document.getElementById('batch-list');
            const searchInput = document.getElementById('batch-search');
            const activeTab = document.querySelector('#batch-tabs .tab-btn.active').dataset.tab;
            const searchTerm = searchInput.value.toLowerCase();
            const favourites = JSON.parse(localStorage.getItem('favourites')) || [];
            
            batchListDiv.innerHTML = '';
            const batches = allData.batches ? Object.entries(allData.batches).sort(([,a],[,b]) => (a.order || 0) - (b.order || 0)) : [];
            
            batches.forEach(([batchId, batch]) => {
                const isFavourite = favourites.includes(batchId);
                if ((activeTab === 'favourites' && !isFavourite) || !batch.title.toLowerCase().includes(searchTerm)) return;

                const card = document.createElement('div');
                card.className = 'batch-card';
                card.innerHTML = `
                    <img src="${batch.imageUrl}" alt="${batch.title}" onerror="this.src='https://placehold.co/600x300/283040/ffffff?text=${batch.title}'">
                    <div class="card-content">
                        <h4>${batch.title}</h4>
                        <div class="fav-icon ${isFavourite ? 'is-favourite' : ''}" data-batch-id="${batchId}">
                            <i class="fas fa-heart"></i>
                        </div>
                    </div>`;
                
                card.addEventListener('click', (e) => {
                    if (e.target.closest('.fav-icon')) {
                        e.preventDefault();
                        let favs = JSON.parse(localStorage.getItem('favourites')) || [];
                        if (favs.includes(batchId)) {
                            favs = favs.filter(id => id !== batchId);
                        } else {
                            favs.push(batchId);
                        }
                        localStorage.setItem('favourites', JSON.stringify(favs));
                        renderHomePage();
                    } else {
                        const isFreeAccess = allData.settings?.freeAccess === 'ON';
                        // MODIFIED: Check for expiry time
                        const expiryTimestamp = getCookie(`unlock_expires_${batchId}`);
                        const isUnlocked = expiryTimestamp && new Date().getTime() < parseInt(expiryTimestamp);

                        if (isFreeAccess || isUnlocked) {
                            navigate('subjects-page', { batchId });
                        } else {
                            currentBatchIdToUnlock = batchId;
                            showAccessModal();
                        }
                    }
                });
                batchListDiv.appendChild(card);
            });
        }

        function renderSubjectsPage(batchId) {
            const batch = allData.batches?.[batchId];
            if (!batch) { navigate('home-page'); return; }
            document.getElementById('subjects-page-title').textContent = batch.title;
            const listDiv = document.getElementById('subject-list');
            listDiv.innerHTML = '';
            Object.entries(batch.subjects || {}).forEach(([subjectId, subject]) => {
                const card = document.createElement('a');
                card.className = 'subject-card';
                card.onclick = () => navigate('chapters-page', { batchId, subjectId });
                card.innerHTML = `<div><h5>${subject.title}</h5><p>${Object.keys(subject.chapters || {}).length} Chapters</p></div>`;
                listDiv.appendChild(card);
            });
        }

        function renderChaptersPage(batchId, subjectId) {
            const subject = allData.batches?.[batchId]?.subjects?.[subjectId];
            if (!subject) { navigate('subjects-page', {batchId}); return; }
            document.getElementById('chapters-page-title').textContent = subject.title;
            const listDiv = document.getElementById('chapter-list');
            listDiv.innerHTML = '';
            appendChapterCards(listDiv, subject.chapters, `batches/${batchId}/subjects/${subjectId}/chapters`, false);
        }
        
        function appendChapterCards(container, chapters, basePath, isSubChapter) {
            if(!chapters) return;
            Object.entries(chapters).forEach(([id, chapter]) => {
                const path = `${basePath}/${id}`;
                const card = document.createElement('a');
                card.className = isSubChapter ? 'chapter-card sub-chapter-card' : 'chapter-card';
                card.innerHTML = `<h5>${isSubChapter ? '<i class="fas fa-folder"></i>' : ''}${chapter.title}</h5>`;
                card.onclick = () => navigate('content-page', { path });
                container.appendChild(card);
                
                if (chapter.chapters) {
                    appendChapterCards(container, chapter.chapters, `${path}/chapters`, true);
                }
            });
        }
        
        function renderContentPage(path) {
            if (!path) { history.back(); return; }
            let chapter;
            try {
                chapter = path.split('/').reduce((obj, key) => obj[key], allData);
                if (!chapter) throw new Error("Chapter not found");
            } catch (e) {
                console.error("Could not find chapter at path:", path);
                history.back(); return;
            }

            document.getElementById('content-page-title').textContent = chapter.title;
            const tabsContainer = document.getElementById('content-tabs-container');
            const panelsContainer = document.getElementById('content-panels-container');
            tabsContainer.innerHTML = '';
            panelsContainer.innerHTML = '';

            if (!chapter.content) {
                panelsContainer.innerHTML = '<p>No content available for this chapter.</p>';
                return;
            }
            
            const contentByType = { lecture: [], note: [], dpp: [] };
            Object.values(chapter.content).forEach(item => contentByType[item.type]?.push(item));
            const tabNames = { lecture: "Lectures", note: "Notes", dpp: "DPP" };
            let isFirstTab = true;

            for (const type in tabNames) {
                if (contentByType[type].length > 0) {
                    const panelId = `panel-${type}`;
                    const tabButton = document.createElement('button');
                    tabButton.className = 'content-tab-btn' + (isFirstTab ? ' active' : '');
                    tabButton.dataset.panelId = panelId;
                    tabButton.textContent = `${tabNames[type]} (${contentByType[type].length})`;
                    
                    const panelDiv = document.createElement('div');
                    panelDiv.className = 'content-panel' + (isFirstTab ? ' active' : '');
                    panelDiv.id = panelId;
                    
                    contentByType[type].forEach(item => {
                        let iconClass = 'fa-play-circle'; // Default
                        if (item.type === 'lecture') {
                            iconClass = 'fa-video';
                        } else if (item.type === 'note' || item.type === 'dpp') {
                            iconClass = 'fa-file-pdf';
                        }
                        panelDiv.innerHTML += `<div class="content-list-item"><a href="${item.url}" target="_blank" rel="noopener noreferrer"><i class="fas ${iconClass}"></i> ${item.title}</a></div>`;
                    });
                    
                    tabsContainer.appendChild(tabButton);
                    panelsContainer.appendChild(panelDiv);
                    isFirstTab = false;
                }
            }

            tabsContainer.onclick = e => {
                if(e.target.matches('.content-tab-btn')) {
                    tabsContainer.querySelector('.active')?.classList.remove('active');
                    panelsContainer.querySelector('.active')?.classList.remove('active');
                    e.target.classList.add('active');
                    document.getElementById(e.target.dataset.panelId).classList.add('active');
                }
            };
        }

        // --- NEW: MODAL HANDLING FUNCTIONS ---
        function showAccessModal() {
            accessModal.classList.remove('hidden');
            // Reset to initial state every time it's shown
            accessModal.querySelector('#initial-state').classList.remove('hidden');
            accessModal.querySelector('#success-state').classList.add('hidden');
        }

        function hideAccessModal() {
            accessModal.classList.add('hidden');
        }

        document.getElementById('generate-key-btn').addEventListener('click', () => {
            if (currentBatchIdToUnlock) {
                const unlockDuration = allData.settings?.unlockDuration || 24; // Duration in hours
                const expirationTime = new Date().getTime() + (unlockDuration * 60 * 60 * 1000);
                
                // Set cookie with expiration timestamp
                setCookie(`unlock_expires_${currentBatchIdToUnlock}`, expirationTime, unlockDuration);
                
                // Start the timer immediately
                updateTimerDisplay(currentBatchIdToUnlock);

                // Show success state in the modal
                accessModal.querySelector('#initial-state').classList.add('hidden');
                accessModal.querySelector('#success-state').classList.remove('hidden');

                // Navigate to the batch page after a short delay
                setTimeout(() => {
                    hideAccessModal();
                    navigate('subjects-page', { batchId: currentBatchIdToUnlock });
                }, 2500); // 2.5 second delay to show the success message
            }
        });
        
        accessModal.querySelector('.close-modal-btn').addEventListener('click', hideAccessModal);

        // --- EXISTING EVENT LISTENERS ---
        document.querySelectorAll('.back-arrow').forEach(arrow => arrow.onclick = () => history.back());
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const closeSidebar = () => { sidebar.classList.remove('open'); overlay.classList.remove('show'); };
        document.getElementById('menu-btn').addEventListener('click', () => { sidebar.classList.add('open'); overlay.classList.add('show'); });
        document.getElementById('close-btn').addEventListener('click', closeSidebar);
        overlay.addEventListener('click', closeSidebar);
        document.getElementById('batch-search').addEventListener('input', renderHomePage);
        document.getElementById('batch-tabs').addEventListener('click', e => {
            if (e.target.classList.contains('tab-btn')) {
                document.querySelector('#batch-tabs .active').classList.remove('active');
                e.target.classList.add('active');
                renderHomePage();
            }
        });
        
        onValue(ref(database), (snapshot) => {
            try {
                allData = snapshot.val() || {};
                const state = history.state || { page: window.location.hash.slice(1) || 'home-page' };
                if (!history.state) {
                   history.replaceState({ page: 'home-page' }, '', '#home-page');
                }
                renderPage(state.page, state);
                
                // NEW: Check for and resume any active timers on data load
                startOrResumeTimer();
                
                const settings = allData.settings || {};
                const logoUrl = settings.logoLink || '';
                document.querySelectorAll('.logo').forEach(el => el.src = logoUrl);
                document.querySelectorAll('#header-logo-link, #sidebar-logo-link').forEach(el => el.href = settings.logoLink || '#');
                document.getElementById('telegram-link').href = settings.telegramLink || '#';
                document.getElementById('contact-link').href = settings.contactLink || '#';
                
            } catch (error) {
                console.error("Firebase data handling error:", error);
                renderPage('home-page', {});
            }
        }, (error) => {
            console.error("Firebase connection error:", error);
            loader.classList.add('hidden');
            document.body.innerHTML = '<div style="text-align: center; padding-top: 50px;"><h2>Could not connect to database.</h2><p>Please check your internet connection and try again.</p></div>';
        });

        const presenceDisplayRef = ref(database, 'presence');
        onValue(presenceDisplayRef, (snapshot) => {
            const count = snapshot.size;
            const countElement = document.getElementById('active-users-count');
            if (countElement) {
                countElement.textContent = count;
            }
        });
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getDatabase, ref, runTransaction, onValue, onDisconnect, push, set } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC1m25mHpA59xBQmF34BfA1K_vY2pUSrLI",
            authDomain: "fahad-portfolio-81c65.firebaseapp.com",
            databaseURL: "https://fahad-portfolio-81c65-default-rtdb.firebaseio.com",
            projectId: "fahad-portfolio-81c65",
            storageBucket: "fahad-portfolio-81c65.firebasestorage.app",
            messagingSenderId: "510625882446",
            appId: "1:510625882446:web:b23f76808b3dd0e79a3e1f"
        };

        const analyticsApp = initializeApp(firebaseConfig, "analyticsAndPresenceApp"); 
        const database = getDatabase(analyticsApp);

        function incrementVisitCount() {
            const visitsRef = ref(database, 'analytics/visits');
            runTransaction(visitsRef, (currentValue) => (currentValue || 0) + 1);
        }
        if (!localStorage.getItem('visitCounted')) {
            incrementVisitCount();
            localStorage.setItem('visitCounted', 'true');
        }

        const presenceRef = ref(database, 'presence');
        const connectedRef = ref(database, '.info/connected');

        onValue(connectedRef, (snap) => {
          if (snap.val() === true) {
            const myConnectionRef = push(presenceRef);
            onDisconnect(myConnectionRef).remove();
            set(myConnectionRef, true);
          }
        });
    </script>
    </body>
</html>
